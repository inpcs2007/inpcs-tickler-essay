# CloudSaaS微服务架构源代码的架构解析

### 一、整理目录结构

> **1. cloud-auth （身份认证鉴权中心）**

| **子服务** | **备注** |
| :---: | :---: |
| cloud-auth-client | 鉴权客户端 |
| cloud-auth-common | 鉴权公共库 |
| cloud-auth-server | 鉴权服务端 SpringBoot |

> **2. cloud-center** （服务注册中心 SpringBoot）
>
> **3. cloud-common** （公共库）
>
> **4. cloud-control** （统一监控运维中心 SpringBoot）

| **子服务** | **备注** |
| :---: | :---: |
| cloud-monitor | 服务监控 SpringBoot |
| cloud-trace | 鉴权公共库 |
| cloud-auth-server | 鉴权服务端 SpringBoot |

> **5. cloud-gate** （统一网关中心）

| **子服务** | **备注** |
| :---: | :---: |
| cloud-gate-ratelimit | 微服务限流 SpringBoot |
| cloud-gateway-v2 | 微服务网关 SpringBoot |
| cloud-gate-zuul | 微服务网关 SpringBoot |

> **6. cloud-modules** （微服务后端模块管理）

| **子服务** | **备注** |
| :---: | :---: |
| cloud-admin | 后台管理端服务 SpringBoot |
| cloud-generator | 服务代码生成 SpringBoot |
| cloud-interface | 服务接口 |
| cloud-tool | 服务工具库 |

> **7. cloud-sidecar** （异构语言整合（非java））

| **子服务** | **备注** |
| :---: | :---: |
| cloud-sidecar-client-demo | 异构语言整合客户端 |
| cloud-sidecar-server | 异构语言整合SpringBoot |

### 二、模块详细讲解

#### **1. cloud-auth （身份认证鉴权中心）**

身份认证鉴权中心包括“鉴权客户端”、“鉴权公共库”、“鉴权服务端”三个部分，现在详细讲解下每个部分。

##### １）cloud-auth-client（鉴权客户端）

```
├── pom.xml
└── src
    └── main
        └── java
            └── cn
                └── inpcs
                    └── saas
                        └── security
                            └── auth
                                └── client
                                    ├── annotation
                                    │   ├── IgnoreClientToken.java----------忽略服务鉴权
                                    │   └── IgnoreUserToken.java------------忽略用户鉴权
                                    ├── config
                                    │   ├── FeignOkHttpConfig.java----------FeignOkHttp集成
                                    │   ├── ServiceAuthConfig.java
                                    │   └── UserAuthConfig.java
                                    ├── configuration
                                    │   └── AutoConfiguration.java
                                    ├── EnableAceAuthClient.java
                                    ├── exception
                                    │   ├── JwtIllegalArgumentException.java
                                    │   ├── JwtSignatureException.java
                                    │   └── JwtTokenExpiredException.java
                                    ├── feign
                                    │   └── ServiceAuthFeign.java
                                    ├── interceptor
                                    │   ├── OkHttpTokenInterceptor.java
                                    │   ├── ServiceAuthRestInterceptor.java
                                    │   └── UserAuthRestInterceptor.java
                                    ├── jwt
                                    │   ├── ServiceAuthUtil.java
                                    │   └── UserAuthUtil.java
                                    └── runner
                                        └── AuthClientRunner.java
```

> annotation包

annotation中的扩展讲解：参见 \[[https://www.cnblogs.com/gmq-sh/p/4798194.html](https://www.cnblogs.com/gmq-sh/p/4798194.html)\] 描述。

```
元注解的作用就是负责注解其他注解。Java5.0定义了4个标准的meta-annotation类型，它们被用来提供对其它 annotation类型作说明。Java5.0定义的元注解：
  1.@Target,
  2.@Retention,
  3.@Documented,
  4.@Inherited
　　这些类型和它们所支持的类在java.lang.annotation包中可以找到。下面我们看一下每个元注解的作用和相应分参数的使用说明。

@Target：

  @Target说明了Annotation所修饰的对象范围：Annotation可被用于 packages、types（类、接口、枚举、Annotation类型）、类型成员（方法、构造方法、成员变量、枚举值）、方法参数和本地变量（如循环变量、catch参数）。在Annotation类型的声明中使用了target可更加明晰其修饰的目标。

作用：用于描述注解的使用范围（即：被描述的注解可以用在什么地方）

取值(ElementType)有：
  1.CONSTRUCTOR:用于描述构造器
  2.FIELD:用于描述域
  3.LOCAL_VARIABLE:用于描述局部变量
  4.METHOD:用于描述方法
  5.PACKAGE:用于描述包
  6.PARAMETER:用于描述参数
  7.TYPE:用于描述类、接口(包括注解类型) 或enum声明

@Retention：
  @Retention定义了该Annotation被保留的时间长短：某些Annotation仅出现在源代码中，而被编译器丢弃；而另一些却被编译在class文件中；编译在class文件中的Annotation可能会被虚拟机忽略，而另一些在class被装载时将被读取（请注意并不影响class的执行，因为Annotation与class在使用上是被分离的）。使用这个meta-Annotation可以对 Annotation的“生命周期”限制。

作用：表示需要在什么级别保存该注释信息，用于描述注解的生命周期（即：被描述的注解在什么范围内有效）

取值（RetentionPoicy）有：
  1.SOURCE:在源文件中有效（即源文件保留）
  2.CLASS:在class文件中有效（即class保留）
  3.RUNTIME:在运行时有效（即运行时保留）
Retention meta-annotation类型有唯一的value作为成员，它的取值来自java.lang.annotation.RetentionPolicy的枚举类型值。
```

> config包

config包中包含了“FeignOkHttpConfig”、“ServiceAuthConfig”、“UserAuthConfig”三个配置

FeignOkHttpConfig集成Feign和OkHttp的配置文件  
_**A. 介绍Feign**_  
　Feign使得 Java HTTP 客户端编写更方便。Feign 灵感来源于Retrofit、JAXRS-2.0和WebSocket。Feign 最初是为了降低统一绑定Denominator 到 HTTP API 的复杂度，不区分是否支持 Restful。  
　你可以使用 Jersey 和 CXF 这些来写一个 Rest 或 SOAP 服务的java客服端。你也可以直接使用 Apache HttpClient 来实现。但是 Feign 的目的是尽量的减少资源和代码来实现和 HTTP API 的连接。通过自定义的编码解码器以及错误处理，你可以编写任何基于文本的 HTTP API。  
_**Feign的扩展讲解参见 \[**_[_**https://blog.csdn.net/u010862794/article/details/73649616\**_](https://blog.csdn.net/u010862794/article/details/73649616\)_**\] 中的描述。**_

_**B. 介绍OkHttp**_

** ** OkHttp 库的设计和实现的首要目标是高效。这也是选择 OkHttp 的重要理由之一。OkHttp 提供了对最新的 HTTP 协议版本 HTTP/2 和 SPDY 的支持，这使得对同一个主机发出的所有请求都可以共享相同的套接字连接。如果 HTTP/2 和 SPDY 不可用，OkHttp 会使用连接池来复用连接以提高效率。OkHttp 提供了对 GZIP 的默认支持来降低传输内容的大小。OkHttp 也提供了对 HTTP 响应的缓存机制，可以避免不必要的网络请求。当网络出现问题时，OkHttp 会自动重试一个主机的多个 IP 地址。在springcloud建议采用Okhttp替换默认的HttpClient 。

OkHttp中集成SpringCloud的扩展讲解：参见\[[https://blog.csdn.net/songhaifengshuaige/article/details/74188106\](https://blog.csdn.net/songhaifengshuaige/article/details/74188106\)\] 中的描述。

OkHttp中的扩展讲解：参见\[[https://www.jianshu.com/p/da4a806e599b\] ](https://www.jianshu.com/p/da4a806e599b中的描述，在) 中的描述。

FeignOkHttpConfig中的扩展讲解：参见\[[http://okeeper.leanote.com/post/使用Spring-Cloud-Feign作为HTTP客户端调用远程HTTP服务](http://okeeper.leanote.com/post/使用Spring-Cloud-Feign作为HTTP客户端调用远程HTTP服务\)\]  中的描述。

```
ServiceAuthConfig
```

```
ServiceAuthConfig
```



